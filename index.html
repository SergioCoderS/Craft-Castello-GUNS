<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Castello Guns</title>
<style>
  :root{--bg:#071023;--card:#0f1724;--muted:#9aa3b2;--accent:#ff4444;--glass:rgba(255,255,255,0.03)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:linear-gradient(180deg,#071023 0%, #061226 100%);color:#e6eef8}
  .app{max-width:1100px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:20px;color:var(--accent)}
  .top-controls{display:flex;gap:8px;align-items:center}
  .tabs{display:flex;gap:8px;margin-top:12px}
  .tab{padding:8px 12px;border-radius:10px;background:var(--card);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .tab.active{box-shadow:0 8px 20px rgba(2,6,23,0.6);border-color:var(--accent)}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px}
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,0.6)}
  .list{max-height:64vh;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
  th{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--glass);margin:4px;font-size:13px}
  .controls {display:flex;gap:8px;align-items:center;margin-bottom:8px}
  input,textarea,select{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit}
  button{background:var(--accent);border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
  .detail h3{margin:0 0 8px 0}
  .resource-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .admin-form{display:flex;flex-direction:column;gap:8px}
  .admin-form textarea{min-height:120px}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:none;color:#fff}
  @media(max-width:900px){.layout{grid-template-columns:1fr}.panel{padding:12px}.tabs{flex-wrap:wrap}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Castello Guns</h1>
        <div class="small">Виправлений</div>
      </div>
      <div class="top-controls">
        <div class="small">Адмін:</div>
        <button id="toggleAdmin" type="button">Увімкнути</button>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="weapons">Зброя</div>
      <div class="tab" data-tab="ingots">Злитки</div>
      <div class="tab" data-tab="parts">Запчастини</div>
    </div>

    <div class="layout">
      <section class="panel">
        <div class="controls">
          <input id="search" placeholder="Пошук... (назва або ресурс)" />
          <select id="categoryFilter"><option value="">Усі категорії</option></select>
          <select id="weaponSelect"></select>
          <button id="showTotals" type="button">Порахувати підсумок</button>
        </div>

        <div class="list">
          <table id="mainTable">
            <thead><tr><th>Назва</th><th class="small">Категорія</th><th>Ресурсів</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

      </section>

      <aside class="panel">
        <div id="detail" class="detail">
          <h3 id="dTitle">Оберіть предмет</h3>
          <div id="dCategory" class="small"></div>
          <div id="dResources"></div>
          <hr />
          <h4>Зведені (базові) ресурси</h4>
          <div id="dTotals"></div>
        </div>

        <div style="margin-top:12px" class="small">Дії:</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportTotalsCSV" type="button">Експорт (CSV)</button>
          <button id="addSample" type="button">Додати тестовий рецепт</button>
        </div>

        <div id="adminPanel" style="display:none;margin-top:12px">
          <h4>Admin: Додати / Редагувати рецепт</h4>
          <div class="admin-form">
            <input id="admName" placeholder="Назва" />
            <select id="admCat"><option value="Гвинтівка">Гвинтівка</option><option value="Дробовик">Дробовик</option><option value="Револьвер">Револьвер</option><option value="Ріпітер">Ріпітер</option><option value="Запчастини">Запчастини</option><option value="Злитки">Злитки</option><option value="Інше">Інше</option></select>
            <textarea id="admResources" placeholder="Ресурс:кількість (по рядку)
Наприклад:
Дуло:1
Дерево:5
Шуруп:10"></textarea>
            <div style="display:flex;gap:8px">
              <button id="saveRecipe" type="button">Зберегти</button>
              <button id="cancelEdit" type="button">Скасувати</button>
            </div>
          </div>
        </div>

      </aside>
    </div>

    <footer style="margin-top:12px;color:var(--muted);font-size:13px">Порада: у полі ресурсів використовуйте саме ті назви ресурсів, які є у списку злитків/запчастин для автоматичного розгортання.</footer>
  </div>

  <div id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  // ------- data -------
  const INGOTS = {
    "Злиток заліза": {"Вугілля":5,"Залізна руда":10,"Форма з глини":1},
    "Злиток золота": {"Вугілля":5,"Золота руда":10,"Форма з глини":1},
    "Злиток латуні": {"Вугілля":5,"Злиток міді":1,"Злиток цинку":1,"Форма з глини":1},
    "Злиток міді": {"Вугілля":5,"Мідна руда":10,"Форма з глини":1},
    "Злиток свинцю": {"Вугілля":5,"Свинцева руда":10,"Форма з глини":1},
    "Злиток Срібла": {"Вугілля":5,"Срібна руда":10,"Форма з глини":1},
    "Злиток сталі": {"Вугілля":5,"Злиток заліза":1,"Форма з глини":1},
    "Злиток цинку": {"Вугілля":5,"Цинкова руда":1,"Форма з глини":1},
    "Форма з глини": {"Вугілля":5,"Глина":5}
  };

  const PARTS = {
    "Барабан": {"Злиток сталі":1},
    "Дуло": {"Злиток сталі":1},
    "Пружина 10шт": {"Злиток заліза":1},
    "Шуруп 20шт": {"Злиток заліза":1},
    "Корпус важкої зброї": {"Злиток заліза":2,"Злиток сталі":2,"Дерево":10,"Шуруп":10},
    "Корпус легкої зброї": {"Злиток заліза":1,"Злиток сталі":1,"Дерево":5,"Шуруп":5}
  };

  let RECIPES = [
    {id:1,name:"Ремонтний набір",cat:"Інструменти",resources:{"Злиток заліза":1,"Тканина":5,"Дерево":1,"Шуруп":5,"Пружина":2}},
    {id:2,name:"Гвинтівка Boltaction",cat:"Гвинтівка",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":25,"Шуруп":10,"Пружина":3,"Злиток сталі":4}},
    {id:3,name:"Гвинтівка Springfield",cat:"Гвинтівка",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":20,"Шуруп":10,"Пружина":3,"Злиток сталі":4}},
    {id:4,name:"Дробовик Double Barrel",cat:"Дробовик",resources:{"Корпус важкої зброї":1,"Дуло":2,"Дерево":5,"Шуруп":20,"Пружина":2,"Злиток сталі":3}},
    {id:5,name:"Дробовик Repeating",cat:"Дробовик",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":5,"Шуруп":15,"Пружина":2,"Злиток сталі":2}},
    {id:6,name:"Дробовик Semi-Auto",cat:"Дробовик",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":5,"Шуруп":15,"Пружина":2,"Злиток сталі":2,"Злиток Срібла":2,"Злиток золота":2}},
    {id:7,name:"Револьвер Cattleman",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":1,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":3,"Злиток сталі":2}},
    {id:8,name:"Револьвер Double Action",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":1,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":3,"Злиток сталі":2}},
    {id:9,name:"Револьвер Double Action Gambler",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":1,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":3,"Злиток сталі":2}},
    {id:10,name:"Револьвер Lemat",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":2,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":4,"Злиток сталі":2}},
    {id:11,name:"Револьвер Navy",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":1,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":3,"Злиток сталі":3,"Злиток золота":1,"Злиток Срібла":1}},
    {id:12,name:"Револьвер Schofield",cat:"Револьвер",resources:{"Корпус легкої зброї":1,"Дуло":1,"Барабан":1,"Дерево":1,"Шуруп":10,"Пружина":3,"Злиток сталі":2}},
    {id:13,name:"Ріпітер Carbine",cat:"Ріпітер",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":5,"Шуруп":15,"Пружина":4,"Злиток сталі":3}},
    {id:14,name:"Ріпітер Evans",cat:"Ріпітер",resources:{"Корпус важкої зброї":1,"Дуло":1,"Дерево":10,"Шуруп":15,"Пружина":4,"Злиток сталі":3}},
    {id:15,name:"Ріпітер Lancaster",cat:"Ріпітер",resources:{"Корпус важкої зброї":1,"Дуло":2,"Дерево":5,"Шуруп":15,"Пружина":4,"Злиток сталі":3}},
    {id:16,name:"Ріпітер Lichfield",cat:"Ріпітер",resources:{"Корпус важкої зброї":1,"Дуло":2,"Дерево":5,"Шуруп":15,"Пружина":4,"Злиток сталі":3}}
  ];

  // expose for debug
  window.__RECIPES = RECIPES; window.__INGOTS = INGOTS; window.__PARTS = PARTS;

  // ------- utils -------
  function showToast(text, ms=1400){
    const t = document.getElementById('toast'); t.textContent = text; t.style.display='block';
    clearTimeout(t._hide); t._hide = setTimeout(()=>{ t.style.display='none'; }, ms);
  }

  function expandResource(name, qty, totals){
    if(PARTS[name]){
      const recipe = PARTS[name];
      for(const [k,v] of Object.entries(recipe)) expandResource(k, v * qty, totals);
      return;
    }
    if(INGOTS[name]){
      const recipe = INGOTS[name];
      for(const [k,v] of Object.entries(recipe)) expandResource(k, v * qty, totals);
      return;
    }
    totals[name] = (totals[name]||0) + qty;
  }

  function expandResources(resources){
    const totals = {};
    for(const [name,qty] of Object.entries(resources)) expandResource(name, qty, totals);
    return totals;
  }

  function countComponents(resources){ let sum=0; for(const v of Object.values(resources)) sum+=v; return sum; }

  // ------- dom refs -------
  const mainTbody = document.querySelector('#mainTable tbody');
  const weaponSelect = document.getElementById('weaponSelect');
  const categoryFilter = document.getElementById('categoryFilter');
  const searchInput = document.getElementById('search');
  const dTitle = document.getElementById('dTitle');
  const dCategory = document.getElementById('dCategory');
  const dResources = document.getElementById('dResources');
  const dTotals = document.getElementById('dTotals');
  const exportBtn = document.getElementById('exportTotalsCSV');
  const addBtn = document.getElementById('addSample');
  const toggleAdminBtn = document.getElementById('toggleAdmin');
  const admPanel = document.getElementById('adminPanel');
  const admName = document.getElementById('admName');
  const admCat = document.getElementById('admCat');
  const admResources = document.getElementById('admResources');
  const saveRecipeBtn = document.getElementById('saveRecipe');
  const cancelEditBtn = document.getElementById('cancelEdit');

  // safety checks
  if(!mainTbody || !weaponSelect){ console.error('DOM elements missing'); showToast('Помилка: елементи інтерфейсу не знайдені'); return; }

  // ------- render helpers -------
  function refreshCategoryOptions(){
    const cats = Array.from(new Set(RECIPES.map(r=>r.cat))).sort();
    categoryFilter.innerHTML = '<option value="">Усі категорії</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  function renderWeaponSelector(){
    weaponSelect.innerHTML = RECIPES.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
  }

  function selectRecipe(id){
    const r = RECIPES.find(x=>String(x.id)===String(id)); if(!r){ console.warn('recipe not found', id); return; }
    dTitle.textContent = r.name; dCategory.textContent = r.cat;
    dResources.innerHTML = Object.entries(r.resources).map(([k,v])=>`<div class="resource-row"><div>${k}</div><div>${v}</div></div>`).join('');
    const totals = expandResources(r.resources);
    dTotals.innerHTML = Object.entries(totals).map(([k,v])=>`<div class="pill">${k}: ${v}</div>`).join('');
    weaponSelect.value = r.id;
    console.log('selectRecipe', r.name);
  }

  function renderList(){
    const q = (searchInput.value||'').trim().toLowerCase();
    const cat = categoryFilter.value;
    mainTbody.innerHTML='';
    RECIPES.forEach(r=>{
      if(cat && r.cat!==cat) return;
      const text = (r.name + ' ' + Object.keys(r.resources).join(' ')).toLowerCase();
      if(q && !text.includes(q)) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="cursor:pointer">${r.name}</td><td class="small">${r.cat}</td><td>${countComponents(r.resources)}</td>`;
      tr.addEventListener('click',()=>selectRecipe(r.id));
      mainTbody.appendChild(tr);
    });
    renderWeaponSelector();
  }

  // ------- events -------
  weaponSelect.addEventListener('change', ()=>{ selectRecipe(weaponSelect.value); showToast('Оберено: ' + weaponSelect.options[weaponSelect.selectedIndex].text); });

  document.getElementById('showTotals').addEventListener('click', ()=>{
    const q = (searchInput.value||'').trim().toLowerCase();
    const cat = categoryFilter.value;
    const pool = RECIPES.filter(r=>{
      if(cat && r.cat!==cat) return false;
      const text = (r.name + ' ' + Object.keys(r.resources).join(' ')).toLowerCase();
      if(q && !text.includes(q)) return false;
      return true;
    });
    const agg = {};
    pool.forEach(r=>{
      const t = expandResources(r.resources);
      for(const [k,v] of Object.entries(t)) agg[k]=(agg[k]||0)+v;
    });
    dTotals.innerHTML = Object.entries(agg).map(([k,v])=>`<div class="pill">${k}: ${v}</div>`).join('');
    showToast('Підсумок по ' + pool.length + ' предметам');
  });

  exportBtn.addEventListener('click', ()=>{
    const pills = Array.from(document.querySelectorAll('#dTotals .pill'));
    const rows = [['Ресурс','Кількість']];
    pills.forEach(p=>{
      const [name,val] = p.textContent.split(':').map(s=>s.trim()); rows.push([name,val]);
    });
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'totals.csv'; document.body.appendChild(link); link.click(); link.remove();
    showToast('CSV згенеровано');
  });

  addBtn.addEventListener('click', ()=>{
    const id = RECIPES.length?Math.max(...RECIPES.map(r=>r.id))+1:1;
    RECIPES.push({id,name:`Тестова зброя ${id}`,cat:'Інше',resources:{'Дерево':5,'Дуло':1}});
    refreshCategoryOptions(); renderList(); showToast('Додано тестовий рецепт');
  });

  toggleAdminBtn.addEventListener('click', ()=>{
    const visible = admPanel.style.display !== 'block';
    admPanel.style.display = visible? 'block':'none';
    toggleAdminBtn.textContent = visible? 'Вимкнути':'Увімкнути';
    showToast(visible? 'Admin увімкнено':'Admin вимкнено');
  });

  function parseResourcesText(text){
    const lines = (text||'').split('\n').map(l=>l.trim()).filter(Boolean);
    const res = {};
    for(const line of lines){
      const parts = line.split(':'); if(parts.length<2) continue;
      const name = parts[0].trim(); const qty = parseInt(parts[1].trim()) || 0;
      res[name]=qty;
    }
    return res;
  }

  saveRecipeBtn.addEventListener('click', ()=>{
    const name = (admName.value||'').trim(); if(!name){ alert('Введіть назву'); return; }
    const cat = admCat.value; const resources = parseResourcesText(admResources.value);
    const existing = RECIPES.find(r=>r.name===name);
    if(existing){
      existing.cat = cat; existing.resources = resources;
      showToast('Оновлено рецепт');
    } else {
      const id = RECIPES.length?Math.max(...RECIPES.map(r=>r.id))+1:1;
      RECIPES.push({id,name,cat,resources});
      showToast('Додано рецепт');
    }
    admName.value=''; admResources.value=''; refreshCategoryOptions(); renderList();
  });

  cancelEditBtn.addEventListener('click', ()=>{ admName.value=''; admResources.value=''; showToast('Редагування скасовано'); });

  mainTbody.addEventListener('dblclick', (e)=>{
    const tr = e.target.closest('tr'); if(!tr) return;
    const name = tr.children[0].textContent; const r = RECIPES.find(x=>x.name===name); if(!r) return;
    admPanel.style.display='block'; toggleAdminBtn.textContent='Вимкнути';
    admName.value = r.name; admCat.value = r.cat; admResources.value = Object.entries(r.resources).map(([k,v])=>`${k}:${v}`).join('\n');
    showToast('Редагування: ' + r.name);
  });

  searchInput.addEventListener('input', renderList);
  categoryFilter.addEventListener('change', renderList);

  // tabs
  Array.from(document.querySelectorAll('.tab')).forEach(t=>t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const tab = t.dataset.tab;
    if(tab==='ingots'){
      mainTbody.innerHTML = '';
      Object.entries(INGOTS).forEach(([k,v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="cursor:pointer">${k}</td><td class="small">Злитки</td><td>${Object.keys(v).length}</td>`;
        tr.addEventListener('click', ()=>{ dTitle.textContent=k; dCategory.textContent='Злитки'; dResources.innerHTML = Object.entries(v).map(([rk,rv])=>`<div class="resource-row"><div>${rk}</div><div>${rv}</div></div>`).join(''); const totals=expandResources(v); dTotals.innerHTML = Object.entries(totals).map(([kk,vv])=>`<div class="pill">${kk}: ${vv}</div>`).join(''); });
        mainTbody.appendChild(tr);
      });
    } else if(tab==='parts'){
      mainTbody.innerHTML = '';
      Object.entries(PARTS).forEach(([k,v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="cursor:pointer">${k}</td><td class="small">Запчастини</td><td>${Object.keys(v).length}</td>`;
        tr.addEventListener('click', ()=>{ dTitle.textContent=k; dCategory.textContent='Запчастини'; dResources.innerHTML = Object.entries(v).map(([rk,rv])=>`<div class="resource-row"><div>${rk}</div><div>${rv}</div></div>`).join(''); const totals=expandResources(v); dTotals.innerHTML = Object.entries(totals).map(([kk,vv])=>`<div class="pill">${kk}: ${vv}</div>`).join(''); });
        mainTbody.appendChild(tr);
      });
    } else {
      renderList();
    }
  }));

  // init
  refreshCategoryOptions(); renderList(); if(RECIPES.length) selectRecipe(RECIPES[0].id);
  console.log('UI initialized');
});
</script>
</body>
</html>










